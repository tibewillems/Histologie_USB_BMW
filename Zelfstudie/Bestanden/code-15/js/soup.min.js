// Inspired by base2 and Prototype
(function(){var a=!1;this.Class=function(){},Class.extend=function(b){function h(b){if(!(this instanceof arguments.callee))return new arguments.callee(arguments);!a&&this.init&&this.init.apply(this,b.callee?b:arguments)}var c=this.prototype,d,e,f,g;a=!0,d=new this,a=!1;for(e in b)d[e]=typeof b[e]=="function"&&typeof c[e]=="function"?function(a,b){return function(){return f=this._super,this._super=c[a],g=b.apply(this,arguments),this._super=f,g}}(e,b[e]):b[e];return h.prototype=d,h.constructor=h,h.extend=arguments.callee,h}})(),function(){function a(a){return document.getElementById(a)}var b=0;Score=Class.extend({init:function(b){b=b||{},this.opts=b,this.layout=b.layout||"{points} points",this.e_clock=a(b.clock),this.e_point=a(b.points),this.restart()},now:function(){return(new Date).getTime()},restart:function(){this.start=this.stopTime=this.last=this.now(),this.points=this.opts.startPoint||1e4,this.updatePoints(),this.startTime()},updatePoints:function(){this.e_point.innerHTML=this.layout.replace("{points}",this.points)},startTime:function(){var a=this;this.uuid=b,function(){if(a.uuid==b){var c=a.stopTime=a.now();a.e_clock.innerHTML=a.time(),c-a.last>(a.opts.every||1e4)&&(a.last=c,a.down(a.opts.deduct||10)),setTimeout(arguments.callee,1e3)}}()},stop:function(){++b},up:function(a){this.points+=a,this.updatePoints()},down:function(a){this.points-=a,this.updatePoints()},getTime:function(){return this.stopTime-this.start},getScore:function(){return this.points},time:function(){var a=~~((this.stopTime-this.start)/1e3),b=a%60,c=~~(a/60),d=~~(c/60);return c%=60,(d>9?d:"0"+d)+":"+(c>9?c:"0"+c%60)+":"+(b>9?b:"0"+b)}})}(),function(){function h(a,b,c,d,g){var h,i=c.length,j,k=1,l=b.length-1,m=f[a],n=e[a],o={row:d,col:g};if(m(l,i-1,o))return 0;for(h=0;h<i;h++){j=c.charAt(h);if(b[o.row][o.col]&&b[o.row][o.col]!=j)return 0;b[o.row][o.col]==j&&k++,n(o)}return k}function i(a,b,c,d,f){var g=c.length,h=e[a],i={row:d,col:f};for(var j=0;j<g;j++)b[i.row][i.col]=c.charAt(j),j<g-1&&h(i);return i}function j(a,b){var c;for(c in b)b.hasOwnProperty(c)&&!(c in a)&&(a[c]=b[c]);return a}function k(a,b){var c=document.getElementById(a).innerHTML;for(var d in b)b.hasOwnProperty(d)&&(c=c.replace(new RegExp("{"+d+"}","g"),b[d]));return c}function l(a){var b=m(a);return b.getContext||G_vmlCanvasManager.initElement(b),b.getContext("2d")}function m(a){return document.getElementById(a)}function o(a,b){return parseInt(Math.random()*(b-a+1))+a}function p(){return String.fromCharCode(o(a,b))}function q(a){return a[o(0,a.length-1)]||a[0]}function r(a){var b=[],c=0;for(;c<a;c++)b.push({});return b}function s(){return words}function t(a){var b=[];for(var c in a)a.hasOwnProperty(c)&&b.push(c);return b}function u(a,b,c,e){var f=r(b),j={};f.wordsNum=0,e=e<b*2?e:b*2;var k=(new Date).getTime();while(a.length&&f.wordsNum<e&&(new Date).getTime()-k<900){var l={};for(var m=0;m<c;m++){var n=q(a),p=o(0,b-1),s=o(0,b-1),t=q(d),u=h(t,f,n,s,p);if(l[n]&&l[n].score>u)continue;l[n]={score:u,dir:t,word:n,ini:{row:s,col:p}}}var v=0,w=null;for(var n in l)l[n].score>v&&(v=l[n].score,w=l[n]);w&&(j[w.word]=w,f.wordsNum++,a.splice(g(a,w.word),1),w.end=i(w.dir,f,w.word,w.ini.row,w.ini.col))}return f.wordlist=j,f}function v(a){var b=0,c=0;if(a.offsetParent)do b+=a.offsetLeft,c+=a.offsetTop;while(a=a.offsetParent);return{x:b,y:c}}function w(a){a.clearRect(0,0,a.canvas.width,a.canvas.width)}function y(a){return function(b){b.preventDefault(),b=b.touches?b.touches[0]:b,a._mousedown=!0,pos=a.pos=v(a.l_ctx.canvas),a._inix=(b.pageX-a.pos.x+1||b.offsetX+1)-1,a._iniy=(b.pageY-a.pos.y+1||b.offsetY+1)-1,a._row=parseInt(a._iniy/a.c_size),a._col=parseInt(a._inix/a.c_size)}}function z(a){return function(b){b.preventDefault(),a._mousedown=!1,w(a.l_ctx);var c=a.lastx,d=a.lasty,e=parseInt(d/a.c_size),f=parseInt(c/a.c_size);if(Math.abs(a._row-e)==Math.abs(a._col-f)||a._col==f&&a._row!=e||a._row==e&&a._col!=f){var g=a._col-f,h=a._row-e,i=[];if(g==0){h=h>0?-1:1;for(var j=a._row;j!=e+h;j+=h)i.push(a.grid[j][f]||"-")}else if(h==0){g=g>0?-1:1;for(var j=a._col;j!=f+g;j+=g)i.push(a.grid[e][j]||"-")}else{h=h>0?-1:1,g=g>0?-1:1;var j=a._row,k=a._col;while(j!=e+h&&k!=f+g)i.push(a.grid[j][k]||"-"),j+=h,k+=g}var l=i.slice().reverse().join("");i=i.join("");if(a.grid.wordlist[i]||a.grid.wordlist[l])i=(a.grid.wordlist[i]||a.grid.wordlist[l]).word,a.cross(i,a._row,a._col,e,f),m("soup-"+i).className="crossed",m("soup-"+i).innerHTML=i}}}function A(a){return function(b){b.preventDefault(),b=b.touches?b.touches[0]:b;if(!a._mousedown)return;var c=(b.pageX-a.pos.x+1||b.offsetX+1)-1,d=(b.pageY-a.pos.y+1||b.offsetY+1)-1,e=a.l_ctx;w(e),e.lineCap="round",e.strokeStyle=a.opts.selectColor,e.globalAlpha=.5,e.lineWidth=a.c_size*.8,e.beginPath(),e.moveTo(a._inix,a._iniy),e.lineTo(c,d),e.stroke(),e.closePath(),a.lastx=c,a.lasty=d}}var a="a".charCodeAt(0),b="z".charCodeAt(0),d="S SW SO N NW NO W O".split(" "),e={S:function(a){a.row++},SW:function(a){a.row++,a.col--},SO:function(a){a.row++,a.col++},N:function(a){a.row--},NW:function(a){a.row--,a.col--},NO:function(a){a.row--,a.col++},W:function(a){a.col--},O:function(a){a.col++}},f={S:function(a,b,c){return c.row+b>a},SW:function(a,b,c){return c.row+b>a||c.col-b<0},SO:function(a,b,c){return c.row+b>a||c.col+b>a},N:function(a,b,c){return c.row-b<0},NW:function(a,b,c){return c.row-b<0||c.col-b<0},NO:function(a,b,c){return c.row-b<0||c.col+b>a},W:function(a,b,c){return c.col-b<0},O:function(a,b,c){return c.col+b>a}},g=function(){return[].indexOf?function(a,b){return a.indexOf(b)}:function(a,b){for(var c=0,d=a.length;c<d;c++)if(b===a[c])return c;return-1}}();closeModal=function(a){return a.parentNode.className="hide",m("overlay").className="hide",!1};var n=function(a,b,c){return document.addEventListener?function(a,b,c){a.addEventListener(b,c,!1)}:function(a,c,d){a.attachEvent("on"+c,function(a){return a=a||b,a.preventDefault=a.preventDefault||function(){this.returnValue=!1},a.stopPropagation=a.stopPropagation||function(){this.cancelBubble=!0},d.call(a.target||a.srcElement,a)})}}(),x={fontSize:12,fontFamily:"Arial",color:"black",selectColor:"blue",size:20,wordsNum:20,clock:"clock",points:"points",layout:"You have {points} points",startPoint:1e3,every:1e4,deduct:10};Soup=Class.extend({init:function(a){this.g_ctx=l("grid"),this.s_ctx=l("lines"),this.l_ctx=l("layer"),this.ctxs=[this.g_ctx,this.s_ctx,this.l_ctx],this.wrap=m("word-search"),this.desc=m("word-description"),this.list=m("word-list"),this.opts=j(a||{},x),this.score=new Score(this.opts),this.setSize(),this.setWordsNum(),this.restart(),this.init_events()},setSize:function(a){this.opts.size=a||this.opts.size,m("set-size").value=this.opts.size},getSize:function(a){return this.opts.size},setWordsNum:function(a){var b=this.opts.size;a=a||this.opts.wordsNum,this.opts.wordsNum=a,m("set-words").value=a<=b?1:a<=b*1.5?"1.5":2},getWordsNum:function(a){return this.opts.wordsNum},setFontSize:function(a){this.opts.fontSize=a,this.draw_grid(),this.draw_founds()},getFontSize:function(){return this.opts.fontSize},show_score:function(a,b){var c=m("congrat");c.className="modal",m("overlay").className="",c.innerHTML=k("congrat-tmpl",{time:a,score:b})},restart:function(){this.data=s(),this.grid=u(t(this.data),this.opts.size,50,this.opts.wordsNum),this.draw_word_list(),this.draw_grid(this.g_ctx),this.cross_points=[],this.founds={},this.score.restart()},hint:function(a){if(!(a in this.grid.wordlist))return;var b=this.grid.wordlist[a];this.founds[a]||(typeof this.opts.onHint=="function"&&this.opts.onHint.call(this),this.cross(a,b.ini.row,b.ini.col,b.end.row,b.end.col),m("soup-"+a).className="bad-crossed",m("soup-"+a).innerHTML=a,this.draw_founds())},cross:function(a,b,c,d,e){if(this.founds[a])return;this.cross_points.push({c1:c,r1:b,c2:e,r2:d}),this.founds[a]=!0,this.draw_founds()/*,this.desc.innerHTML=this.data[a].replace(new RegExp("\\b"+a+"\\b","i"),"<b>"+a+"</b>")*/;if(this.cross_points.length==this.grid.wordsNum){this.score.stop();var f=this.score.getScore(),g=this.score.time();this.show_score(g,f),this.opts.onFinish.call(this,g,f)}return!0},draw_word_list:function(){var a=this.list;this.list.innerHTML="",a.id="soup-word-list";for(var b in this.grid.wordlist)if(this.grid.wordlist.hasOwnProperty(b)){var c=document.createElement("li"),d=document.createElement("a");d.innerHTML="toon",d.href="#",c.innerHTML=b+" ",c.appendChild(d),c.id="soup-"+b,a.appendChild(c)}this.wrap.appendChild(a)},draw_founds:function(){var a=this.s_ctx;w(a),a.lineCap="round",a.strokeStyle="red",a.globalAlpha=.5,a.lineWidth=this.c_size*.8,a.beginPath();var b=this.opts.fontSize,c=this.c_size;for(var d=0;d<this.cross_points.length;d++){var e=this.cross_points[d];a.moveTo(e.c1*c+b,e.r1*c+b),a.lineTo(e.c2*c+b,e.r2*c+b)}a.stroke(),a.closePath()},set_canvas_size:function(a){for(var b=0;b<3;b++)this.ctxs[b].canvas.width=this.ctxs[b].canvas.height=a;this.wrap.style.width=a+270+"px",this.wrap.style.height=this.list.style.height=a+"px",this.desc.style.marginTop=a+10+"px"},draw_grid:function(a){a=this.g_ctx;var b=this.grid.length,d=this.opts.fontSize,e=this.c_size=d*2,f=e*b,g,h;this.set_canvas_size(f),a.textAlign="center",a.font=d+"px "+this.opts.fontFamily,a.fillStyle=this.opts.color;for(g=0;g<b;g++)for(h=0;h<b;h++)this.grid[g][h]=this.grid[g][h]||p(),c=this.grid[g][h].toUpperCase(),a.beginPath(),a.fillText(c,e*h+d,e*g+d*1.4),this.opts.draw_cells&&(a.rect(e*h,e*g,e,e),a.stroke()),a.closePath()},init_events:function(){var a=this.pos=v(this.g_ctx.canvas),b=this;this.l_ctx.canvas.onselectstart=function(){return!1},this.l_ctx.canvas.onmousedown=function(){return!1},n(this.l_ctx.canvas,"mousedown",y(this)),n(this.l_ctx.canvas,"mouseup",z(this)),n(this.l_ctx.canvas,"mousemove",A(this));if("ontouchstart"in window||window.DocumentTouch&&document instanceof DocumentTouch)n(this.l_ctx.canvas,"touchstart",y(this)),n(this.l_ctx.canvas,"touchend",z(this)),n(this.l_ctx.canvas,"touchmove",A(this));n(m("restart"),"click",function(){return b.restart(),!1}),n(m("set-size"),"change",function(a){b.setSize(parseInt(this.value)),b.setWordsNum(parseFloat(m("set-words").value)*parseInt(this.value)),b.restart(),b.score.restart()}),n(m("set-words"),"change",function(a){b.setWordsNum(b.getSize()*parseFloat(this.value)),b.restart(),b.score.restart()}),n(m("font-size-up"),"click",function(a){a.preventDefault(),b.setFontSize(b.getFontSize()+1)}),n(m("font-size-down"),"click",function(a){a.preventDefault(),b.setFontSize(b.getFontSize()-1)}),n(m("show-help"),"click",function(a){a.preventDefault(),m("overlay").className="",m("help").className="modal"}),n(m("overlay"),"click",function(a){m("help").className=m("congrat").className=this.className="hide"}),n(this.wrap,"click",function(a){var c=a.target||a.srcElement;c.tagName.toLowerCase()=="a"&&(b.hint(c.parentNode.id.replace("soup-","")),a.preventDefault())})}})}();
